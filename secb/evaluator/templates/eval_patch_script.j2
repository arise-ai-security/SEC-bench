# Copy patch from mounted directory to /testcase without overwriting existing files
cp /tmp/model_patch.diff /testcase/

echo "Step 1: Git apply"
cd {{ work_dir }}
secb patch
ret=$?
if [ ${ret} -ne 0 ]; then
    echo "FAIL_STEP: Git apply; exit code=${ret}"
    exit ${ret}
else
    echo "SUCCESS: Git apply passed; exit code=${ret}"
fi

echo "Step 2: Compile"
secb build
ret=$?
if [ ${ret} -ne 0 ]; then
    echo "FAIL_STEP: Compile; exit code=${ret}"
    exit ${ret}
else
    echo "SUCCESS: Compile passed; exit code=${ret}"
fi

echo "Step 3: Run PoC"
timeout 10 secb repro
ret=$?
echo "Run PoC exit code: ${ret}"
if [ ${ret} -ne 0 ]; then
    echo "TENTATIVE: Run PoC; exit code=${ret}"
    exit ${ret}
else
    echo "SUCCESS: Run PoC passed; exit code=${ret}"
    exit 0
fi 